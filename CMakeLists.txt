cmake_minimum_required(VERSION 3.20)
project(RuneCaster
    VERSION 1.0.0
    DESCRIPTION "Modern C++ Text Processing Framework"
    LANGUAGES CXX
)

# C++20 í‘œì¤€ ì„¤ì •
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# C++20 ëª¨ë“ˆ ì§€ì›ì€ í–¥í›„ ì¶”ê°€ ì˜ˆì •
# set(CMAKE_EXPERIMENTAL_CXX_MODULE_CMAKE_API "2182bf5c-ef0d-489a-91da-49dbc3090d2a")
# set(CMAKE_EXPERIMENTAL_CXX_MODULE_DYNDEP ON)

# ë¹Œë“œ ì˜µì…˜
option(RUNE_CASTER_ENABLE_TESTS "Enable testing" ON)
option(RUNE_CASTER_ENABLE_BENCHMARKS "Enable benchmarking" OFF)
option(RUNE_CASTER_ENABLE_EXAMPLES "Enable examples" ON)
option(RUNE_CASTER_ENABLE_STATIC_ANALYSIS "Enable static analysis tools" OFF)

# ì˜ì¡´ì„± ê´€ë¦¬ ì˜µì…˜
option(RUNE_CASTER_USE_SYSTEM_FMT "Use system-installed fmt library" OFF)
option(RUNE_CASTER_USE_SYSTEM_SPDLOG "Use system-installed spdlog library" OFF)
option(RUNE_CASTER_USE_SYSTEM_ICU "Use system-installed ICU library" ON)
option(RUNE_CASTER_ENABLE_ICU "Enable ICU Unicode support" ON)
option(RUNE_CASTER_ENABLE_FMT "Enable fmt formatting library" ON)
option(RUNE_CASTER_ENABLE_SPDLOG "Enable spdlog logging library" ON)

# FetchContent ëª¨ë“ˆ í¬í•¨
include(FetchContent)

# ì˜ì¡´ì„± ê´€ë¦¬ í•¨ìˆ˜
function(fetch_dependency name git_repo git_tag)
    string(TOUPPER ${name} name_upper)
    if(RUNE_CASTER_USE_SYSTEM_${name_upper})
        find_package(${name} QUIET)
        if(${name}_FOUND)
            message(STATUS "Using system ${name}")
            return()
        else()
            message(STATUS "System ${name} not found, falling back to FetchContent")
        endif()
    endif()

    message(STATUS "Fetching ${name} from ${git_repo} (${git_tag})")
    FetchContent_Declare(
        ${name}
        GIT_REPOSITORY ${git_repo}
        GIT_TAG ${git_tag}
        GIT_SHALLOW TRUE
    )
    FetchContent_MakeAvailable(${name})
endfunction()

# === FetchContent ì˜ì¡´ì„± ===

# fmt ë¼ì´ë¸ŒëŸ¬ë¦¬ (í¬ë§·íŒ…)
if(RUNE_CASTER_ENABLE_FMT)
    fetch_dependency(fmt "https://github.com/fmtlib/fmt.git" "10.2.1")
endif()

# spdlog ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë¡œê¹…)
if(RUNE_CASTER_ENABLE_SPDLOG)
    fetch_dependency(spdlog "https://github.com/gabime/spdlog.git" "v1.12.0")
endif()

# === ì‹œìŠ¤í…œ ì˜ì¡´ì„± (ë³µì¡í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤) ===

# ICU ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜µì…˜ ì„¤ì •
option(RUNE_CASTER_USE_FETCHCONTENT_ICU "Use FetchContent to download ICU instead of system ICU" OFF)
option(RUNE_CASTER_USE_UNI_ALGO "Use uni-algo as a lightweight Unicode alternative to ICU" ON)

# ICU ë¼ì´ë¸ŒëŸ¬ë¦¬ (ìœ ë‹ˆì½”ë“œ ì§€ì›) - ë³µì¡í•˜ë¯€ë¡œ ì‹œìŠ¤í…œ ì„¤ì¹˜ ìš°ì„ 
if(RUNE_CASTER_ENABLE_ICU AND RUNE_CASTER_USE_SYSTEM_ICU)
    find_package(PkgConfig QUIET)
    find_package(ICU COMPONENTS uc i18n data QUIET)
    if(NOT ICU_FOUND)
        message(STATUS "ICU not found via CMake, trying pkg-config")
        if(PkgConfig_FOUND)
            pkg_check_modules(ICU QUIET icu-uc icu-i18n)
        endif()
    endif()

    if(NOT ICU_FOUND AND NOT ICU_LIBRARIES)
        message(STATUS "ICU not found. Using built-in Unicode fallback implementation.")
        message(STATUS "For full Unicode support, install ICU:")
        message(STATUS "  Windows: vcpkg install icu")
        message(STATUS "  Ubuntu: sudo apt install libicu-dev")
        message(STATUS "  macOS: brew install icu4c")
        message(STATUS "Alternative: Set RUNE_CASTER_USE_FETCHCONTENT_ICU=ON or RUNE_CASTER_USE_UNI_ALGO=ON")
    endif()
endif()

# FetchContent ICU ì˜µì…˜ (ì‹¤í—˜ì )
if(RUNE_CASTER_ENABLE_ICU AND RUNE_CASTER_USE_FETCHCONTENT_ICU AND NOT ICU_FOUND)
    message(STATUS "ğŸš€ Attempting to download ICU via FetchContent (experimental)...")
    message(WARNING "ICU FetchContent is experimental and may take 10-20 minutes to build!")

    # ë°©ë²• 1: viaduck/icu-cmake ë˜í¼ ì‚¬ìš© (ê¶Œì¥)
    FetchContent_Declare(
        icu-cmake
        GIT_REPOSITORY https://github.com/viaduck/icu-cmake.git
        GIT_TAG        master  # ë˜ëŠ” íŠ¹ì • ë¦´ë¦¬ì¦ˆ íƒœê·¸
        GIT_SHALLOW    ON
    )

    # ICU ë¹Œë“œ ì„¤ì • (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
    set(BUILD_ICU ON CACHE BOOL "Build ICU from source")
    set(ICU_BUILD_VERSION "71.1" CACHE STRING "ICU version to build")

    FetchContent_MakeAvailable(icu-cmake)

    if(TARGET icu)
        set(ICU_FOUND TRUE)
        set(ICU_LIBRARIES icu)
        message(STATUS "âœ… ICU successfully downloaded and configured via FetchContent")
    else()
        message(WARNING "âŒ ICU FetchContent failed. Falling back to limited Unicode support.")
    endif()
endif()

# ëŒ€ì•ˆ: uni-algo ê²½ëŸ‰ Unicode ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê¶Œì¥)
if(RUNE_CASTER_USE_UNI_ALGO AND NOT ICU_FOUND)
    message(STATUS "ğŸ¯ Using uni-algo as lightweight Unicode alternative...")

    FetchContent_Declare(
        uni-algo
        GIT_REPOSITORY https://github.com/uni-algo/uni-algo.git
        GIT_TAG        v1.2.0  # ìµœì‹  ì•ˆì • ë²„ì „
        GIT_SHALLOW    ON
    )

    # uni-algo í—¤ë” ì „ìš© ëª¨ë“œ í™œì„±í™” (ì»´íŒŒì¼ ì‹œê°„ ë‹¨ì¶•)
    set(UNI_ALGO_HEADER_ONLY ON CACHE INTERNAL "")

    FetchContent_MakeAvailable(uni-algo)

    if(TARGET uni-algo::uni-algo)
        set(UNI_ALGO_FOUND TRUE)
        message(STATUS "âœ… uni-algo successfully downloaded and configured")
        # target_compile_definitionsëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ê²° ì„¹ì…˜ì—ì„œ ì²˜ë¦¬
    endif()
endif()

# ì„ íƒì  ì˜ì¡´ì„± (ì‹œìŠ¤í…œ ì„¤ì¹˜)
find_package(TBB QUIET)  # ë³‘ë ¬ ì²˜ë¦¬
if(RUNE_CASTER_ENABLE_BENCHMARKS)
    find_package(benchmark QUIET)  # ì„±ëŠ¥ ì¸¡ì •
endif()

# ë©”ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±
add_library(rune_caster)

# ì»´íŒŒì¼ëŸ¬ë³„ í”Œë˜ê·¸ ì„¤ì •
if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
    target_compile_options(rune_caster PRIVATE
        -Wall -Wextra -Wpedantic
        $<$<CONFIG:Release>:-O3 -DNDEBUG>
        $<$<CONFIG:Debug>:-g -O0 -DDEBUG>
    )
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    target_compile_options(rune_caster PRIVATE
        -Wall -Wextra -Wpedantic
        $<$<CONFIG:Release>:-O3 -DNDEBUG>
        $<$<CONFIG:Debug>:-g -O0 -DDEBUG>
    )
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
    target_compile_options(rune_caster PRIVATE
        /W4
        /utf-8  # UTF-8 ì¸ì½”ë”© ê°•ì œ (C4819 ê²½ê³  í•´ê²°)
        /wd4819 # C4819 ê²½ê³  ì–µì œ (ë¬¸ì ì¸ì½”ë”© ê²½ê³ )
        $<$<CONFIG:Release>:/O2 /DNDEBUG>
        $<$<CONFIG:Debug>:/Od /DDEBUG>
    )
endif()

# ì†ŒìŠ¤ íŒŒì¼ë“¤
target_sources(rune_caster
    PRIVATE
        src/rune/rune.cpp
        src/rune/rune_sequence.cpp
        src/spell/whitespace_normalizer.cpp
)

# í—¤ë” í¬í•¨ ê²½ë¡œ
target_include_directories(rune_caster
    PUBLIC
        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include>
    PRIVATE
        src
)

# === ì˜ì¡´ì„± ì—°ê²° ===

# fmt ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ê²°
if(RUNE_CASTER_ENABLE_FMT)
    if(TARGET fmt::fmt)
        target_link_libraries(rune_caster PRIVATE fmt::fmt)
        target_compile_definitions(rune_caster PRIVATE RUNE_CASTER_HAS_FMT)
        message(STATUS "fmt library linked successfully")
    else()
        message(STATUS "fmt not available, using fallback formatting")
    endif()
endif()

# spdlog ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ê²°
if(RUNE_CASTER_ENABLE_SPDLOG)
    if(TARGET spdlog::spdlog)
        target_link_libraries(rune_caster PRIVATE spdlog::spdlog)
        target_compile_definitions(rune_caster PRIVATE RUNE_CASTER_HAS_SPDLOG)
        message(STATUS "spdlog library linked successfully")
    else()
        message(STATUS "spdlog not available, using basic logging")
    endif()
endif()

# ICU ë˜ëŠ” uni-algo ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ê²°
if(RUNE_CASTER_ENABLE_ICU)
    if(ICU_FOUND AND TARGET icu)
        # FetchContent ICU (viaduck/icu-cmake)
        target_link_libraries(rune_caster PUBLIC icu)
        target_compile_definitions(rune_caster PRIVATE RUNE_CASTER_HAS_ICU)
        message(STATUS "FetchContent ICU library linked successfully")
    elseif(ICU_FOUND)
        # ì‹œìŠ¤í…œ ICU
        target_link_libraries(rune_caster PUBLIC ICU::uc ICU::i18n ICU::data)
        target_compile_definitions(rune_caster PRIVATE RUNE_CASTER_HAS_ICU)
        message(STATUS "System ICU library linked successfully")
    elseif(ICU_LIBRARIES)
        # pkg-config ICU
        target_link_libraries(rune_caster PUBLIC ${ICU_LIBRARIES})
        target_include_directories(rune_caster SYSTEM PUBLIC ${ICU_INCLUDE_DIRS})
        target_compile_definitions(rune_caster PRIVATE RUNE_CASTER_HAS_ICU)
        message(STATUS "ICU library (pkg-config) linked successfully")
    elseif(UNI_ALGO_FOUND)
        # uni-algo ëŒ€ì•ˆ
        target_link_libraries(rune_caster PUBLIC uni-algo::uni-algo)
        target_compile_definitions(rune_caster PRIVATE RUNE_CASTER_HAS_UNI_ALGO)
        message(STATUS "uni-algo Unicode library linked successfully")
    else()
        message(STATUS "No Unicode library available, using basic fallback support")
    endif()
endif()

# TBB ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ê²° (ì„ íƒì )
if(TBB_FOUND)
    target_link_libraries(rune_caster PRIVATE TBB::tbb)
    target_compile_definitions(rune_caster PRIVATE RUNE_CASTER_HAS_TBB)
    message(STATUS "TBB library linked successfully")
endif()

# í•˜ìœ„ ë””ë ‰í† ë¦¬ ì¶”ê°€
if(RUNE_CASTER_ENABLE_TESTS)
    enable_testing()
    add_subdirectory(tests/unit)
endif()

if(RUNE_CASTER_ENABLE_EXAMPLES)
    if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/examples/CMakeLists.txt)
        add_subdirectory(examples)
    endif()
endif()

# === ì„¤ì¹˜ ì„¤ì • (ê°œë°œ ë‹¨ê³„ìš© ê°„ì†Œí™”) ===
# ì°¸ê³ : FetchContentë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, installì€ ë³µì¡í•  ìˆ˜ ìˆìŒ
# í˜„ì¬ëŠ” ê°œë°œ/í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì´ë¯€ë¡œ ê¸°ë³¸ì ì¸ installë§Œ ì œê³µ

include(GNUInstallDirs)

# ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (export ì—†ì´)
install(TARGETS rune_caster
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

# í—¤ë” íŒŒì¼ ì„¤ì¹˜
install(DIRECTORY include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

# TODO: í–¥í›„ ì•ˆì •í™”ë˜ë©´ ì™„ì „í•œ CMake íŒ¨í‚¤ì§€ ì„¤ì • ì¶”ê°€
# - RuneCasterTargets.cmake
# - RuneCasterConfig.cmake
# - RuneCasterConfigVersion.cmake